<!DOCTYPE html><html lang="zh-cn"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.png"><meta name="generator" content="Astro v5.7.13"><!-- Canonical URL --><link rel="canonical" href="https://www.hysling.top/blog/proxy/vps-%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC"><link rel="alternate" type="application/rss+xml" title="Lyndra's Blog" href="/rss.xml"><!-- Primary Meta Tags --><meta name="title" content="VPS 搭建脚本 - Lyndra's Blog"><meta name="description" content="素处以默"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://www.hysling.top/blog/proxy/vps-%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC"><meta property="og:title" content="VPS 搭建脚本 - Lyndra's Blog"><meta property="og:description" content="素处以默"><meta property="og:image" content="https://www.hysling.top/blog/proxy/vps-%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC"><!-- <meta property="og:image:alt" content={site.description}/> --><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.hysling.top/blog/proxy/vps-%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC"><meta property="twitter:title" content="VPS 搭建脚本 - Lyndra's Blog"><meta property="twitter:description" content="素处以默"><meta property="twitter:image" content="https://www.hysling.top/blog/proxy/vps-%E6%90%AD%E5%BB%BA%E8%84%9A%E6%9C%AC"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="sitemap" href="/sitemap-0.xml"><title>VPS 搭建脚本 - Lyndra&#39;s Blog</title><script src="/toggle-theme.js"></script><script async type="text/javascript" src="/load-mathjax.js"></script><script async type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/_astro/BlogPost.BUYUBhIy.css">
<link rel="stylesheet" href="/_astro/WalineComment.XaQ6XQsx.css">
<link rel="stylesheet" href="/_astro/about.gIe6_up2.css">
<link rel="stylesheet" href="/_astro/_slug_.DYqrg3Zi.css">
<style>#donate-item-img{filter:grayscale(1)}#donate-item-img:hover{filter:blur(0px);cursor:pointer}.esa-sponsor{position:relative;width:100%;margin:40px 0}.esa-sponsor .qrshow{position:absolute;width:200px;height:200px;cursor:pointer;left:calc(50% - 100px);top:-170px;z-index:999;display:none;box-shadow:0 1px 15px #1b1f2326,0 0 1px #6a737d59}
.post-title[data-astro-cid-6t6zfk7k]:hover{outline:0;color:#cc7a00;text-shadow:1px 1px 1px #ffd147}.toc_container[data-astro-cid-6t6zfk7k]{overflow-y:scroll;scrollbar-width:none;-ms-overflow-style:none}.toc_container[data-astro-cid-6t6zfk7k]::-webkit-scrollbar{width:0;height:0}.toc_container[data-astro-cid-6t6zfk7k] a[data-astro-cid-6t6zfk7k]{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
</style></head><body class="bg-skin-secondary"> <header class="fixed top-0 w-full bg-skin-fill text-skin-base z-10"> <div class="flex items-center justify-between container"> <div class="block xl:hidden"> <button type="button" id="menu-icon" class="header-btn" title="Menu"> <i class="ri-menu-fill"></i> </button> <button type="button" id="menu-icon-close" class="header-btn hidden" title="Menu"> <i class="ri-close-fill"></i> </button> <script type="module">let n=document.getElementById("menu-icon"),t=document.getElementById("menu-icon-close"),l=document.getElementById("mobile-menu"),e=document.getElementById("aside-btn"),i=document.getElementById("aside-close-btn"),s=document.getElementById("personal-info");n.addEventListener("click",()=>{e&&e.classList.contains("hidden")&&d([e,i,s]),d([n,t,l])});t.addEventListener("click",()=>{d([n,t,l])});function d(o){o.forEach(c=>{c.classList.toggle("hidden")})}</script> </div> <a class="text-2xl p-4" href="/">Lyndra&#39;s Blog</a> <div class="flex items-center"> <div class="hidden xl:block"> <div class="flex items-center space-x-5 pr-4"> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/blog/1" target="_self" class="header-link-active hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-draft-line" data-astro-cid-eimmu3lg></i> 博客  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/feed/1" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-lightbulb-flash-line" data-astro-cid-eimmu3lg></i> 动态  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/archive/1" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-archive-line" data-astro-cid-eimmu3lg></i> 归档  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/message" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-chat-1-line" data-astro-cid-eimmu3lg></i> 留言  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/search" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-search-line" data-astro-cid-eimmu3lg></i> 搜索  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="javascript:void(0);" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-more-fill" data-astro-cid-eimmu3lg></i> 更多 <i class="ri-arrow-down-s-line" data-astro-cid-eimmu3lg></i> </a> <div class="dropdown cursor-pointer border rounded bg-skin-fill p-4" data-astro-cid-eimmu3lg> <ul class="space-y-4 w-28" data-astro-cid-eimmu3lg> <li class="text-center hover:text-skin-active select-none" data-astro-cid-eimmu3lg> <i class="ri-information-line" data-astro-cid-eimmu3lg></i> <a target="_self" href="/about" data-astro-cid-eimmu3lg>关于本站</a> </li><li class="text-center hover:text-skin-active select-none" data-astro-cid-eimmu3lg> <i class="ri-user-5-line" data-astro-cid-eimmu3lg></i> <a target="_self" href="/friends" data-astro-cid-eimmu3lg>友情链接</a> </li> </ul> </div> </div>  </div> </div> <button type="button" id="theme-btn" class="header-btn" title="Toggles light & dark" aria-label="auto" aria-live="polite"> <i id="moon-icon" class="ri-sun-line"></i> <i id="sun-icon" class="ri-moon-line"></i> </button> <div class="block xl:hidden"> <button type="button" id="aside-btn" class="header-btn" title="Open Aside Bar" aria-label="auto" aria-live="polite"> <i class="ri-user-line"></i> </button> <button type="button" id="aside-close-btn" class="header-btn hidden" title="Close Aside Bar" aria-label="auto" aria-live="polite"> <i class="ri-close-fill"></i> </button> <div id="blog-aside" class="absolute top-16 bg-skin-fill right-0 blog-aside hidden"></div> <script type="module">let n=document.getElementById("aside-btn"),t=document.getElementById("aside-close-btn"),e=document.getElementById("menu-icon"),i=document.getElementById("menu-icon-close"),s=document.getElementById("mobile-menu"),l=document.getElementById("personal-info");n.addEventListener("click",()=>{e&&e.classList.contains("hidden")&&d([e,i,s]),d([n,t,l])});t.addEventListener("click",()=>{d([t,l,n])});function d(o){o.forEach(c=>{c.classList.toggle("hidden")})}</script> </div> </div> </div> <div id="mobile-menu" class="hidden text-center overflow-y-auto pb-8" style="height: calc(100vh - 64px)"> <div class="py-2"> <a class=" hover:text-skin-active" href="/blog/1"> <i class="ri-draft-line"></i> <span>博客</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/feed/1"> <i class="ri-lightbulb-flash-line"></i> <span>动态</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/archive/1"> <i class="ri-archive-line"></i> <span>归档</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/message"> <i class="ri-chat-1-line"></i> <span>留言</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/search"> <i class="ri-search-line"></i> <span>搜索</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="javascript:void(0);"> <i class="ri-more-fill"></i> <span>更多</span> </a> <div class="divider-horizontal"></div> <div class="space-y-4 text-sm"> <a class="block hover:text-skin-active" href="/about"> <i class="ri-information-line"></i> <span>关于本站</span> </a><a class="block hover:text-skin-active" href="/friends"> <i class="ri-user-5-line"></i> <span>友情链接</span> </a> </div> </div> </div> <div id="personal-info" class="hidden break-all overflow-y-auto pb-8" style="height: calc(100vh - 64px)"> <img class="avatar my-4 mx-auto" src="/avatar.svg" alt="avatar"> <div class="mb-2 text-center">本来无一物，何处惹尘埃</div> <div class="flex items-center justify-center flex-wrap"> <a title="github" href="https://github.com/LLyndra" target="_blank"> <i class="ri-github-fill text-2xl mr-2 cursor-pointer"></i> </a><a title="rss" href target="_blank"> <i class="ri-rss-fill text-2xl mr-2 cursor-pointer"></i> </a> </div> <div class="divider-horizontal-mini"></div> <div class="text-center"> <div> <i class="ri-folder-3-line menu-icon"></i>分类 </div> <div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="工具教程 (16)" href="/category/工具教程"> 工具教程 (16) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="专业知识 (4)" href="/category/专业知识"> 专业知识 (4) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="编程开发 (8)" href="/category/编程开发"> 编程开发 (8) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="系统维护 (22)" href="/category/系统维护"> 系统维护 (22) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="网络安全 (8)" href="/category/网络安全"> 网络安全 (8) </a> </div> <div class="divider-horizontal-mini"></div>
          <div class="text-center"> <i class="ri-price-tag-3-line menu-icon"></i> 标签 </div> <div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="AI" href="/tags/AI">AI (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="iPhone" href="/tags/iPhone">iPhone (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Performance" href="/tags/Performance">Performance (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Linux" href="/tags/Linux">Linux (17)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Manjaro" href="/tags/Manjaro">Manjaro (8)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Bash" href="/tags/Bash">Bash (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Server" href="/tags/Server">Server (8)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Network" href="/tags/Network">Network (4)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Hardware" href="/tags/Hardware">Hardware (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Astro" href="/tags/Astro">Astro (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Github" href="/tags/Github">Github (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Blog" href="/tags/Blog">Blog (3)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Siyuan" href="/tags/Siyuan">Siyuan (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Archlinux" href="/tags/Archlinux">Archlinux (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Shell" href="/tags/Shell">Shell (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Downgrade" href="/tags/Downgrade">Downgrade (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Cursor" href="/tags/Cursor">Cursor (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Git" href="/tags/Git">Git (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Ubuntu" href="/tags/Ubuntu">Ubuntu (6)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Markdown" href="/tags/Markdown">Markdown (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Algorithm" href="/tags/Algorithm">Algorithm (3)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Hugo" href="/tags/Hugo">Hugo (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Github pages" href="/tags/Github pages">Github pages (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Docker" href="/tags/Docker">Docker (5)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="VPS" href="/tags/VPS">VPS (4)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Proxy" href="/tags/Proxy">Proxy (5)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="QEMU" href="/tags/QEMU">QEMU (3)</a> </div> </div> </div> </header> <main class="container p-4  pt-20 text-skin-base min-h-full pb-32 relative" id="app"> <div class="grid grid-cols-4 gap-8"> <div class="col-span-4 xl:col-span-3 space-y-4 first:space-y-2"> <button class="flex items-center text-md cursor-pointer hover:text-skin-active outline-none" style="background-color: inherit;" onclick="history.back()"> <i class="ri-arrow-left-line mr-2"></i> <span>返回</span> </button>  <div> <div> <!-- title --> <h1 class="break-all text-2xl font-bold">VPS 搭建脚本</h1> <div class="flex flex-wrap items-center my-2 text-skin-dodge"> <!-- date --> <div class="mr-2"><i class="ri-calendar-2-fill mr-1"></i>2025-06-03</div> <!-- draft -->  <!-- category --> <a href="/category/系统维护" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-folder-3-line mr-1"></i>系统维护</a><a href="/category/网络安全" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-folder-3-line mr-1"></i>网络安全</a> <!-- tag --> <a href="/tags/VPS" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-hashtag mr-1"></i>VPS</a><a href="/tags/Proxy" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-hashtag mr-1"></i>Proxy</a> <!-- update --> <!--{--> <!--  lastModified && (--> <!--    <div class="mr-2"><i class="ri-calendar-check-fill "></i>{t('post.lastUpdated')}:{lastModified}</div>--> <!--  )--> <!--}--> <!-- minutes --> <div class="mr-2 flex items-center"><i class="ri-hourglass-fill mr-1"></i>21分钟</div>
        <div class="mr-2 flex items-center"><i class="ri-quill-pen-line mr-1"></i>4098字</div> </div>  </div> <div class="divider-horizontal"></div> <article class="markdown-body"> <p>之前建立了完整的 VPS 服务器，由于其中的步骤比较繁琐，当更换服务器后，再次恢复成原来的服务会很麻烦。</p>
<p>因此，把其中的固定步骤转换为脚本，通过脚本可快速的重新搭建 VPS。</p>
<aside aria-label="caution" class="remark-aside remark-aside--caution"><h4 class="remark-aside__title" aria-hidden="true" id="警告"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="remark-aside__icon"><path d="M12 16C11.8022 16 11.6089 16.0587 11.4444 16.1686C11.28 16.2784 11.1518 16.4346 11.0761 16.6173C11.0004 16.8001 10.9806 17.0011 11.0192 17.1951C11.0578 17.3891 11.153 17.5673 11.2929 17.7071C11.4327 17.847 11.6109 17.9422 11.8049 17.9808C11.9989 18.0194 12.2 17.9996 12.3827 17.9239C12.5654 17.8482 12.7216 17.72 12.8315 17.5556C12.9413 17.3911 13 17.1978 13 17C13 16.7348 12.8946 16.4805 12.7071 16.2929C12.5196 16.1054 12.2652 16 12 16ZM22.67 17.47L14.62 3.47003C14.3598 3.00354 13.9798 2.61498 13.5192 2.3445C13.0586 2.07401 12.5341 1.9314 12 1.9314C11.4659 1.9314 10.9414 2.07401 10.4808 2.3445C10.0202 2.61498 9.64019 3.00354 9.38 3.47003L1.38 17.47C1.11079 17.924 0.966141 18.441 0.960643 18.9688C0.955144 19.4966 1.089 20.0166 1.34868 20.4761C1.60837 20.9356 1.9847 21.3185 2.43968 21.5861C2.89466 21.8536 3.41218 21.9964 3.94 22H20.06C20.5921 22.0053 21.1159 21.8689 21.5779 21.6049C22.0399 21.341 22.4234 20.9589 22.689 20.4978C22.9546 20.0368 23.0928 19.5134 23.0895 18.9814C23.0862 18.4493 22.9414 17.9277 22.67 17.47ZM20.94 19.47C20.8523 19.626 20.7245 19.7556 20.5697 19.8453C20.4149 19.935 20.2389 19.9815 20.06 19.98H3.94C3.76111 19.9815 3.5851 19.935 3.43032 19.8453C3.27553 19.7556 3.14765 19.626 3.06 19.47C2.97223 19.318 2.92602 19.1456 2.92602 18.97C2.92602 18.7945 2.97223 18.622 3.06 18.47L11.06 4.47003C11.1439 4.30623 11.2714 4.16876 11.4284 4.07277C11.5855 3.97678 11.766 3.92599 11.95 3.92599C12.134 3.92599 12.3145 3.97678 12.4716 4.07277C12.6286 4.16876 12.7561 4.30623 12.84 4.47003L20.89 18.47C20.9892 18.6199 21.0462 18.7937 21.055 18.9732C21.0638 19.1527 21.0241 19.3312 20.94 19.49V19.47ZM12 8.00003C11.7348 8.00003 11.4804 8.10538 11.2929 8.29292C11.1054 8.48046 11 8.73481 11 9.00003V13C11 13.2652 11.1054 13.5196 11.2929 13.7071C11.4804 13.8947 11.7348 14 12 14C12.2652 14 12.5196 13.8947 12.7071 13.7071C12.8946 13.5196 13 13.2652 13 13V9.00003C13 8.73481 12.8946 8.48046 12.7071 8.29292C12.5196 8.10538 12.2652 8.00003 12 8.00003Z"></path></svg>警告</h4><div class="remark-aside__content"><ul>
<li>
<p>本脚本专注于个人 VPS，默认需要一个域名、一个 Cloudflare 账号解析 DNS。</p>
</li>
<li>
<p>需要运行在 debian 系列的系统的 root 环境。</p>
</li>
<li>
<p>运行脚本前，请按照脚本中的提示修改相关配置参数，比如用户名、密码、端口号等。使用脚本前请先阅读：<a href="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/">年轻人的第一台-vps-代理服务器</a></p>
</li>
<li>
<p>主域名为二级域名，因为 cloudflare 的免费用户只提供二级域名的边缘证书，如果是三级域名，则需要付费。</p>
</li>
<li>
<p>运行脚本过程中，仍需要根据提示手动确认一些操作是否成功。</p>
</li>
</ul></div></aside>
<h2 id="脚本内容">脚本内容</h2>
<p>脚本分为两个，一个是主脚本，包含所有模块，另一个脚本是用于调用主脚本的外壳。脚本也同步分享在 <a href="https://github.com/LLyndra/VPS-Build-Script">github 仓库</a> 中。</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.r9qfg.css"><script type="module" src="/_astro/ec.dy9ns.js"></script><figure class="frame has-title" style="--lnWidth:3ch"><figcaption class="header"><span class="title">build-all.sh 主脚本</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#!/usr/bin/env bash</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██╗  ██╗   ██╗███╗   ██╗██████╗ ██████╗  █████╗</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║  ╚██╗ ██╔╝████╗  ██║██╔══██╗██╔══██╗██╔══██╗</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║   ╚████╔╝ ██╔██╗ ██║██║  ██║██████╔╝███████║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║    ╚██╔╝  ██║╚██╗██║██║  ██║██╔══██╗██╔══██║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ███████╗██║   ██║ ╚████║██████╔╝██║  ██║██║  ██║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ╚══════╝╚═╝   ╚═╝  ╚═══╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 文件名称: build-all.sh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 文件描述: VPS 搭建脚本，包含域名申请，3XUI面板搭建、Sub-Store服务安装、</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#        Hysteria2 安装、Nginx分流配置。需 root 用户运行。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#       运行前请自定义修改117-131的端口号。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>722 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 作者: Lyndra &#x3C;lyndra.hyst@gmail.com></span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 版本: 1.0.0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 创建日期: 2025-04-25</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 最后修改: 2025-05-29</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 使用许可: GPLv2 or other licenses</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># Copyright (c) 2025 Lyndra</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">set</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-eo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">pipefail</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 颜色配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">RED</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0;31m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0;32m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">31</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[1;33m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">32</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">BLUE</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0;34m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">33</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">34</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">35</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 命令配置，格式为：[命令名]="描述::处理函数::选项声明1::选项声明2::..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">36</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">declare</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> COMMAND_MAP</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">(</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">37</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"setup"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"基础环境设置::handle_setup::-u,--user:指定新建用户名（必须）::-p,--pass:指定新建用户密码（必须）::-s,--ssh-port:指定SSH端口（默认：22222）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">38</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"cert"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"证书管理::handle_cert::-d,--domain:指定主域名（必须，建议优先使用二级域名，可免费开启cloudflare代理保护，三级域名不可免费使用）::-e,--email:指定邮箱（必须）::-t,--token:指定Cloudflare API Token（必须）::-z,--zone-id:指定Cloudflare Zone ID（必须）::-a,--account-id:指定Cloudflare Account ID（必须）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">39</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"hysteria"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"Hysteria2服务::handle_hysteria::-d,--domain:指定域名（必须，确定证书路径）::-p,--port:指定端口（默认：8443）::-u,--user:指定用户名（必须）::-w,--pass:指定密码（必须）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">40</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"xui"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"X-UI面板::handle_xui"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">41</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"substore"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"Sub-Store服务::handle_substore::-a,--api-key:指定API密钥（必须）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">42</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[</span><span style="--0:#B392F0;--1:#6F42C1">"nginx"</span><span style="--0:#E1E4E8;--1:#24292E">]=</span><span style="--0:#9ECBFF;--1:#032F62">"Nginx分流配置::handle_nginx::-d,--domain:指定域名（必须，确定证书路径）::-x,--xui-domain:指定X-UI域名（必须）::-s,--substore-domain:指定Sub-Store域名（必须）::-p,--port-xui:指定xui访问端口（必须）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">43</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">44</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">45</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 错误处理函数</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">46</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">47</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">RED</span><span style="--0:#9ECBFF;--1:#032F62">}[错误]${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">48</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">49</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">50</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">51</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 日志输出函数</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">52</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">53</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#9ECBFF;--1:#032F62">}[信息]${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">54</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">55</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">56</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">log_warning</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">57</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}[警告]${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">58</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">59</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">60</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">61</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#9ECBFF;--1:#032F62">}[成功]${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">62</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">63</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">64</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">log_debug</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">65</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">BLUE</span><span style="--0:#9ECBFF;--1:#032F62">}[调试]${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">66</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">67</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">68</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">69</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#          通用的帮助信息生成函数            #</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">70</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">71</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">72</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">73</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">74</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> info</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">COMMAND_MAP</span><span style="--0:#9ECBFF;--1:#032F62">[</span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">]}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">75</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">76</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 1) 把所有 "::" 替换成一个不会在脚本中出现的分隔符，比如 '|'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">77</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">info</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">info</span><span style="--0:#F97583;--1:#BF3441">//::/</span><span style="--0:#9ECBFF;--1:#032F62">|}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">78</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">79</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 2) 这时才能安全地用 IFS='|' 来做分割</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">80</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> desc handler options_str</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">81</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">IFS</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"|"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">desc</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">handler</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">options_str</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;&#x3C;</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$info</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">82</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">83</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}命令: ${</span><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#9ECBFF;--1:#032F62">}</span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">84</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}描述: ${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}</span><span style="--0:#E1E4E8;--1:#24292E">$desc</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">85</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}选项:${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">86</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">87</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 3) 选项声明里可能有多段「::」分隔，继续替换并拆分</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">88</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">options_str</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">options_str</span><span style="--0:#F97583;--1:#BF3441">//::/</span><span style="--0:#9ECBFF;--1:#032F62">|}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">89</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">IFS</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"|"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-ra</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">opt_lines</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;&#x3C;</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$options_str</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">90</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">91</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">for</span><span style="--0:#E1E4E8;--1:#24292E"> opt_line </span><span style="--0:#F97583;--1:#BF3441">in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">opt_lines</span><span style="--0:#9ECBFF;--1:#032F62">[</span><span style="--0:#F97583;--1:#BF3441">@</span><span style="--0:#9ECBFF;--1:#032F62">]}"</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">92</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$opt_line</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#F97583;--1:#BF3441">continue</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">93</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">94</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># opt_line 类似 "-p,--package:指定包名（必须）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">95</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 用 ":" 分割出（短+长选项）和描述</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">96</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">IFS</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">":"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">flags</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">desc</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;&#x3C;</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$opt_line</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">97</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"  ${</span><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#9ECBFF;--1:#032F62">}%-20s${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} %s\n"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$flags</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$desc</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">98</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">99</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">100</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">101</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 主帮助信息</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">102</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">show_help</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">103</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}使用方法:${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">104</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"  </span><span style="--0:#79B8FF;--1:#005CC5">$0</span><span style="--0:#9ECBFF;--1:#032F62"> [命令] [选项]"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">105</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">106</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}可用命令:${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">107</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">for</span><span style="--0:#E1E4E8;--1:#24292E"> cmd </span><span style="--0:#F97583;--1:#BF3441">in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">COMMAND_MAP</span><span style="--0:#9ECBFF;--1:#032F62">[</span><span style="--0:#F97583;--1:#BF3441">@</span><span style="--0:#9ECBFF;--1:#032F62">]}"</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">108</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> desc</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">${COMMAND_MAP[$cmd]</span><span style="--0:#F97583;--1:#BF3441">%%::*</span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">109</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"  ${</span><span style="--0:#E1E4E8;--1:#24292E">GREEN</span><span style="--0:#9ECBFF;--1:#032F62">}%-15s${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} %s\n"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$desc</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">110</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">111</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"\n使用 ${</span><span style="--0:#E1E4E8;--1:#24292E">YELLOW</span><span style="--0:#9ECBFF;--1:#032F62">}</span><span style="--0:#79B8FF;--1:#005CC5">$0</span><span style="--0:#9ECBFF;--1:#032F62"> 命令 --help${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">} 查看具体命令帮助"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">112</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">113</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">114</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">115</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#               命令处理函数                 #</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">116</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">117</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">118</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">119</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># ==========================================</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">120</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># 配置信息开始，请根据实际情况修改</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">121</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># ==========================================</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">122</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">123</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># 新建用户的组id和用户id，默认 1001</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">124</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">groupid</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">1001</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">125</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">userid</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">1001</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">126</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">127</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># ssh 登陆端口配置，请确保该端口未被占用</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">128</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_ssh</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">22222</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">129</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">130</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># Hysteria 主端口配置</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">131</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_hysteria</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">8443</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">132</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">133</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># Hysteria 跳跃端口配置</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">134</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_hysteria_jump_1</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">50220</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">135</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_hysteria_jump_1_end</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">50959</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">136</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_hysteria_jump_2</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">60133</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">137</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">port_hysteria_jump_2_end</span><span style="--0:#fb99a3;--1:#982934">=</span><span style="--0:#9ECBFF;--1:#032F62">60968</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">138</div></div><div class="code">
</div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">139</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># ==========================================</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">140</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># 配置信息结束</span></div></div><div class="ec-line highlight mark"><div class="gutter"><div class="ln">141</div></div><div class="code"><span style="--0:#afb5b9;--1:#4d545b"># ==========================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">142</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">143</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">144</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 基础环境设置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">145</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_setup</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">146</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> username</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">147</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> password</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">148</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">149</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">150</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">151</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--user</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">152</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">username</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">153</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">154</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">155</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--pass</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">156</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">password</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">157</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">158</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">159</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--ssh-port</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">160</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">port_ssh</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">161</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">162</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">163</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">164</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"setup"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">165</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">166</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">167</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">168</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">169</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">170</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">171</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">172</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">173</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定用户名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">174</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$password</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定密码"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">175</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">176</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始设置基础环境..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">177</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">178</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装常用软件</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">179</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装常用软件..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">180</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">update</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">upgrade</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E">&#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt-get</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">vim</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sudo</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">181</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">182</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 创建非root用户</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">183</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"创建非root用户: </span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">184</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">185</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">getent</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">group</span><span style="--0:#E1E4E8;--1:#24292E"> ${groupid} </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">groupadd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-g</span><span style="--0:#E1E4E8;--1:#24292E"> ${groupid} </span><span style="--0:#9ECBFF;--1:#032F62">vps</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">186</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">getent</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">passwd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">useradd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-ms</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/bin/bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-u</span><span style="--0:#E1E4E8;--1:#24292E"> ${userid} </span><span style="--0:#79B8FF;--1:#005CC5">-g</span><span style="--0:#E1E4E8;--1:#24292E"> ${groupid} </span><span style="--0:#79B8FF;--1:#005CC5">-G</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">187</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$password</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">chpasswd</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">188</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62"> ALL=(ALL) NOPASSWD:ALL"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/sudoers</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">189</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">190</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"非root用户创建完成，请在新终端中使用 </span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62"> 用户登录，确认是否生效，生效请输入 y/Y，否则请重新运行脚本"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">191</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请输入y确认："</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">confirm</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">192</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"y"</span><span style="--0:#E1E4E8;--1:#24292E"> ] &#x26;&#x26; [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Y"</span><span style="--0:#E1E4E8;--1:#24292E"> ]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">193</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"非root用户创建完成未生效，请检测系统环境，重新运行脚本"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">194</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">195</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">196</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># SSH安全加固</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">197</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"配置SSH安全设置..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">198</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">199</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 检查 SSH 端口是否已经修改</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">200</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">grep</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-q</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"^Port </span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">201</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"SSH 端口已设置为 </span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">，跳过修改"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">202</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">203</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"s/#Port 22/Port </span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">/"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">204</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"s/^Port 22/Port </span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">/"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">205</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"SSH 端口已修改为 </span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">206</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">207</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">208</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 检查 root 登录是否已经禁用</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">209</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">grep</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-q</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"^PermitRootLogin no"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">210</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Root 登录已禁用，跳过修改"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">211</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">212</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"s/#PermitRootLogin yes/PermitRootLogin no/"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">213</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"s/^PermitRootLogin yes/PermitRootLogin no/"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">214</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Root 登录已禁用"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">215</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">216</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">217</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">218</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">deny</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">22</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">219</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">220</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">restart</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ssh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">221</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">222</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"SSH安全设置完成，请在新终端中使用新端口 ssh -p ${</span><span style="--0:#E1E4E8;--1:#24292E">port_ssh</span><span style="--0:#9ECBFF;--1:#032F62">} ${</span><span style="--0:#E1E4E8;--1:#24292E">username</span><span style="--0:#9ECBFF;--1:#032F62">}@ip，确认是否生效，生效请输入 y/Y，否则请重新运行脚本"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">223</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请输入y确认："</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">confirm</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">224</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"y"</span><span style="--0:#E1E4E8;--1:#24292E"> ] &#x26;&#x26; [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Y"</span><span style="--0:#E1E4E8;--1:#24292E"> ]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">225</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"SSH安全设置未生效，请检测系统环境，重新运行脚本"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">226</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">227</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">228</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 防火墙设置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">229</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"配置防火墙..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">230</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">80</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">231</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">232</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">233</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--force</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">234</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">235</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"基础环境设置完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">236</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">237</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">238</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 证书管理</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">239</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 证书管理 - 改进版本</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">240</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_cert</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">241</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> email</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">242</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> cf_token</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">243</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> cf_zone_id</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">244</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> cf_account_id</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">245</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">246</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> key_type</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"ec-256"</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#99A0A6;--1:#616972"># 新增：默认使用 EC-256</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">247</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">248</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">249</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">250</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--domain</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">251</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">252</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">253</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">254</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--email</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">255</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">email</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">256</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">257</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">258</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--token</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">259</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">cf_token</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">260</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">261</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">262</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--zone-id</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">263</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">cf_zone_id</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">264</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">265</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">266</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-a</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--account-id</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">267</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">cf_account_id</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">268</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">269</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">270</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-k</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--key-type</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">271</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">key_type</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">272</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">273</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">274</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">275</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"cert"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">276</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">277</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">278</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">279</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">280</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">281</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">282</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">283</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">284</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定主域名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">285</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$email</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定邮箱"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">286</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_token</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定Cloudflare API Token"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">287</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_zone_id</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定Cloudflare Zone ID"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">288</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_account_id</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定Cloudflare Account ID"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">289</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">290</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 验证密钥类型</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">291</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$key_type</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">292</div></div><div class="code"><span class="indent">    </span><span style="--0:#9ECBFF;--1:#032F62">"ec-256"</span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62">"ec-384"</span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62">"2048"</span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62">"3072"</span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62">"4096"</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">293</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">294</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">295</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"不支持的密钥类型: </span><span style="--0:#E1E4E8;--1:#24292E">$key_type</span><span style="--0:#9ECBFF;--1:#032F62">，支持: ec-256, ec-384, 2048, 3072, 4096"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">296</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">297</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">298</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">299</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始申请TLS证书（密钥类型: </span><span style="--0:#E1E4E8;--1:#24292E">$key_type</span><span style="--0:#9ECBFF;--1:#032F62">）..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">300</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">301</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装acme.sh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">302</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装acme.sh..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">303</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://get.acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">email="</span><span style="--0:#E1E4E8;--1:#24292E">$email</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">304</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">socat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">305</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">~/.acme.sh/acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--set-default-ca</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">letsencrypt</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">306</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">~/.bashrc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">307</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">~/.acme.sh/acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--upgrade</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--auto-upgrade</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">308</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">309</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 设置环境变量</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">310</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Token</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_token</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">311</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Zone_ID</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_zone_id</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">312</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Account_ID</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$cf_account_id</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">313</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">314</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 申请证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">315</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> username</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#B392F0;--1:#6F42C1">id</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-un</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1001</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">316</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">317</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"申请证书: </span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">（密钥类型: </span><span style="--0:#E1E4E8;--1:#24292E">$key_type</span><span style="--0:#9ECBFF;--1:#032F62">）"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">318</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">319</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 检查证书是否已经存在且有效</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">320</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#F97583;--1:#BF3441">-f</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; [[ </span><span style="--0:#F97583;--1:#BF3441">-f</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key"</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">321</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x509</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-noout</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-checkend</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2592000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/null</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">2>&#x26;1</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">322</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书已存在且有效期超过30天，跳过申请"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">323</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书检查完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">324</div></div><div class="code"><span class="indent">      </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">325</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">326</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">log_warning</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书已存在但即将过期或无效，重新申请"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">327</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">328</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">329</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">330</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 构建 acme.sh 命令</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">331</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> acme_cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"~/.acme.sh/acme.sh --issue --dns dns_cf -d </span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#9ECBFF;--1:#032F62"> -d </span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#9ECBFF;--1:#032F62">*.</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">332</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">333</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 添加密钥长度参数</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">334</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">acme_cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$acme_cmd</span><span style="--0:#9ECBFF;--1:#032F62"> --keylength </span><span style="--0:#E1E4E8;--1:#24292E">$key_type</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">335</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">336</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 添加输出文件参数</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">337</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">acme_cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$acme_cmd</span><span style="--0:#9ECBFF;--1:#032F62"> --key-file /home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">338</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">acme_cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$acme_cmd</span><span style="--0:#9ECBFF;--1:#032F62"> --fullchain-file /home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">339</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">acme_cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$acme_cmd</span><span style="--0:#9ECBFF;--1:#032F62"> --reloadcmd 'bash -c </span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#9ECBFF;--1:#032F62">nginx -s reload &#x26;&#x26; x-ui restart</span><span style="--0:#79B8FF;--1:#005CC5">\"</span><span style="--0:#9ECBFF;--1:#032F62">'"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">340</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">341</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 执行命令</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">342</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">eval</span><span style="--0:#E1E4E8;--1:#24292E"> $acme_cmd </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">log_warning</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书申请结果请检查，目前没有安装 nginx，会导致reload失败，但不代表证书申请失败"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">343</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">344</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 修改权限</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">345</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"修改证书权限..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">346</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">chmod</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">644</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">347</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">chmod</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">644</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">348</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">349</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 将证书重命名拷贝，并确保路径正确，主要用于xui设置路径</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">350</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/root/cert/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">351</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/root/cert/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">/fullchain.pem"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">352</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/root/cert/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">/privkey.pem"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">353</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">354</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 验证证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">355</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"验证证书..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">356</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x509</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-noout</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-text</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/null</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">2>&#x26;1</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">357</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书文件有效"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">358</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">359</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 显示证书信息</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">360</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书有效期："</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">361</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x509</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-noout</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-dates</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">362</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">363</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书包含的域名："</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">364</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x509</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-in</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/home/</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-noout</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-text</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">grep</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Subject Alternative Name"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"  </span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">, *.</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">365</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">366</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_warning</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书文件可能有问题，请检查"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">367</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">368</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">369</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"证书申请完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">370</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">371</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">372</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># Hysteria2服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">373</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 逐步在Qos,建议搭建reality</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">374</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_hysteria</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">375</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> username</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">376</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> password</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">377</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">378</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">379</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">380</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">381</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--domain</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">382</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">383</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">384</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">385</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--port</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">386</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">port_hysteria</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">387</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">388</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">389</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--user</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">390</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">username</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">391</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">392</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">393</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-w</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--pass</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">394</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">password</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">395</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">396</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">397</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">398</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"hysteria"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">399</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">400</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">401</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">402</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">403</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">404</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">405</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">406</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">407</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定主域名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">408</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定用户名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">409</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$password</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定密码"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">410</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">411</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始安装Hysteria2服务..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">412</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">413</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装Hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">414</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装Hysteria2..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">415</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#9ECBFF;--1:#032F62"> https://get.hy2.sh/)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">416</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">417</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 配置Hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">418</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"配置Hysteria2..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">419</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">420</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/config.yaml</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">421</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">listen: :</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">422</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">423</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">tls:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">424</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">cert: /home/$(</span><span style="--0:#B392F0;--1:#6F42C1">id</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-un</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#E1E4E8;--1:#24292E">$userid</span><span style="--0:#9ECBFF;--1:#032F62">)/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">425</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">key: /home/$(</span><span style="--0:#B392F0;--1:#6F42C1">id</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-un</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#E1E4E8;--1:#24292E">$userid</span><span style="--0:#9ECBFF;--1:#032F62">)/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">426</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">427</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">auth:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">428</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">type: userpass</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">429</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">userpass:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">430</div></div><div class="code"><span class="indent">    </span><span style="--0:#E1E4E8;--1:#24292E">$username</span><span style="--0:#9ECBFF;--1:#032F62">: </span><span style="--0:#E1E4E8;--1:#24292E">$password</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">431</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">432</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">masquerade:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">433</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">type: proxy</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">434</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">435</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">url: https://bing.com</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">436</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">rewriteHost: true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">437</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">listenHTTP: :80</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">438</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">listenHTTPS: :</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">439</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">440</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">bandwidth:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">441</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">up: 20 mbps</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">442</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">down: 50 mbps</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">443</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">444</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">445</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 配置端口跳跃</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">446</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"配置端口跳跃..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">447</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_1</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_1_end</span><span style="--0:#9ECBFF;--1:#032F62">/udp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">448</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_2</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_2_end</span><span style="--0:#9ECBFF;--1:#032F62">/udp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">449</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_1</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_1_end </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">450</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_2</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_2_end </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">451</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ip6tables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_1</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_1_end </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">452</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ip6tables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria_jump_2</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria_jump_2_end </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">453</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">454</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> $port_hysteria</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">455</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">456</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"启动Hysteria2服务..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">457</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--now</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">458</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">459</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Hysteria2服务安装完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">460</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">461</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">462</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 3X-UI面板</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">463</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_xui</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">464</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">[[</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">465</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">466</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">467</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"xui"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">468</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">469</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">470</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">471</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">472</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">473</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">474</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">475</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">476</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始安装3X-UI面板..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">477</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">478</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装X-UI</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">479</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装3X-UI..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">480</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-Ls</span><span style="--0:#9ECBFF;--1:#032F62"> https://raw.githubusercontent.com/MHSanaei/3x-ui/refs/tags/v2.6.0/install.sh)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">481</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">482</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 配置X-UI</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">483</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请手动配置3X-UI，或者使用3X-UI备份恢复"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">484</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">sleep</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">485</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">486</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"3X-UI面板安装完成，请在 ngninx 反代后，手动完成 ssl 证书路径配置"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">487</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">488</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">489</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># Sub-Store服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">490</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_substore</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">491</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> api_key</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">492</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">493</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">494</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">495</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-a</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--api-key</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">496</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">api_key</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">497</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">498</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">499</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">500</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"substore"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">501</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">502</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">503</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">504</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">505</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">506</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">507</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">508</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">509</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$api_key</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定API密钥"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">510</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">511</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始安装Sub-Store服务..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">512</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">513</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装依赖</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">514</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装依赖..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">515</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">update</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">unzip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">wget</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">git</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">516</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">517</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装FNM</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">518</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装FNM..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">519</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://fnm.vercel.app/install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">bash</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">520</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">~/.bashrc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">521</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">522</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装Node</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">523</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装Node..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">524</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">fnm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">v20.18.0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">525</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">526</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装PNPM</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">527</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装PNPM..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">528</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://get.pnpm.io/install.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">-</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">529</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">~/.bashrc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">530</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">531</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 创建目录</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">532</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"创建目录..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">533</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/sub-store</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">534</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">cd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/sub-store</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">535</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">536</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 下载Sub-Store</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">537</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"下载Sub-Store..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">538</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-o</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub-store.bundle.js</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">539</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-o</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist.zip</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">540</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">unzip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-o</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist.zip</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">mv</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">frontend</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">rm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist.zip</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">541</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">542</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 创建服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">543</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"创建服务..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">544</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/systemd/system/sub-store.service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">545</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">[Unit]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">546</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Description=Sub-Store</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">547</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">After=network-online.target</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">548</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Wants=network-online.target systemd-networkd-wait-online.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">549</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">550</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">[Service]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">551</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">LimitNOFILE=32767</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">552</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Type=simple</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">553</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_FRONTEND_BACKEND_PATH=/</span><span style="--0:#E1E4E8;--1:#24292E">$api_key</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">554</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_BACKEND_CRON=0 0 * * *"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">555</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_FRONTEND_PATH=/root/sub-store/frontend"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">556</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_FRONTEND_HOST=0.0.0.0"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">557</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_FRONTEND_PORT=3001"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">558</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_DATA_BASE_PATH=/root/sub-store"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">559</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_BACKEND_API_HOST=127.0.0.1"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">560</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Environment="SUB_STORE_BACKEND_API_PORT=3000"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">561</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">ExecStart=/root/.local/share/fnm/fnm exec --using v20.18.0 node /root/sub-store/sub-store.bundle.js</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">562</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">User=root</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">563</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Group=root</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">564</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">Restart=on-failure</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">565</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">RestartSec=5s</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">566</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">ExecStartPre=/bin/sh -c ulimit -n 51200</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">567</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">StandardOutput=journal</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">568</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">StandardError=journal</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">569</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">570</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">[Install]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">571</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">WantedBy=multi-user.target</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">572</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">573</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">574</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 启动服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">575</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"启动服务..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">576</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub-store.service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--now</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">577</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">578</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.bashrc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">579</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Sub-Store服务安装完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">580</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">581</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">582</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># Nginx分流配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">583</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">handle_nginx</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">584</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> xui_domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">585</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> substore_domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">586</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">587</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> port_xui</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">""</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">588</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">589</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-gt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]]; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">590</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">case</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">$1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">in</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">591</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--domain</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">592</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">593</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">594</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">595</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-x</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--xui-domain</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">596</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">xui_domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">597</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">598</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">599</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--substore-domain</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">600</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">substore_domain</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">601</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">602</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">603</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--port-xui</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">604</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">port_xui</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$2</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">605</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">shift</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">606</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">607</div></div><div class="code"><span class="indent">    </span><span style="--0:#DBEDFF;--1:#032F62">-h</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#DBEDFF;--1:#032F62">--help</span><span style="--0:#F97583;--1:#BF3441">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">608</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">show_command_help</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"nginx"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">609</div></div><div class="code"><span class="indent">      </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">610</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">611</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">612</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知选项: </span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">613</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">      </span></span><span style="--0:#E1E4E8;--1:#24292E">;;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">614</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">esac</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">615</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">616</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">617</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定主域名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">618</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$xui_domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定X-UI域名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">619</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$substore_domain</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定Sub-Store域名"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">620</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$port_xui</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"必须指定X-UI访问端口"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">621</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">622</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"开始配置Nginx分流..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">623</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">624</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 安装Nginx</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">625</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"安装Nginx..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">626</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">libnginx-mod-stream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">627</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">628</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 配置Nginx</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">629</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"配置Nginx..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">630</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">631</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 修改主配置文件 - 检查是否已经存在 include 语句</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">632</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">grep</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-q</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"include /etc/nginx/vps.conf;"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/nginx.conf</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">633</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"添加 vps.conf 包含语句到 nginx.conf"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">634</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'$a\    include /etc/nginx/vps.conf;'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/nginx.conf</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">635</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">636</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"vps.conf 包含语句已存在，跳过添加"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">637</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">638</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">639</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 创建分流配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">640</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/vps.conf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">641</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62"># /etc/nginx/vps.conf</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">642</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">643</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">stream {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">644</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62"># 定义一个映射，将 SNI 中的服务器名映射到后端标识符</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">645</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">map </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">ssl_preread_server_name </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">backend {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">646</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">hostnames;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">647</div></div><div class="code"><span class="indent">        </span><span style="--0:#E1E4E8;--1:#24292E">$substore_domain</span><span style="--0:#9ECBFF;--1:#032F62"> sub;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">648</div></div><div class="code"><span class="indent">        </span><span style="--0:#E1E4E8;--1:#24292E">$xui_domain</span><span style="--0:#9ECBFF;--1:#032F62"> xui;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">649</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">default hysteria;  # 默认后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">650</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">651</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">652</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62"># 定义各个后端的上游服务器</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">653</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">upstream sub {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">654</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">server 127.0.0.1:8444;  # </span><span style="--0:#E1E4E8;--1:#24292E">$substore_domain</span><span style="--0:#9ECBFF;--1:#032F62"> 对应的后端，对接的是 nginx server</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">655</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">656</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">657</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">upstream xui {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">658</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">server 127.0.0.1:</span><span style="--0:#E1E4E8;--1:#24292E">$port_xui</span><span style="--0:#9ECBFF;--1:#032F62">;  # </span><span style="--0:#E1E4E8;--1:#24292E">$xui_domain</span><span style="--0:#9ECBFF;--1:#032F62"> 对应的后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">659</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">660</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">661</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">upstream hysteria {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">662</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">server 127.0.0.1:</span><span style="--0:#E1E4E8;--1:#24292E">$port_hysteria</span><span style="--0:#9ECBFF;--1:#032F62">;  # 默认后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">663</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">664</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">665</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62"># 定义一个服务器块，监听指定端口并根据 SNI 分发流量</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">666</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">server {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">667</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">listen 443;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">668</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">listen [::]:443;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">669</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy_pass </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">{backend};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">670</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">ssl_preread on;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">671</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">672</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">673</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">674</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">675</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 创建Sub-Store服务器配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">676</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">cat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/sites-enabled/vps.conf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">677</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">server {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">678</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">listen 8444 ssl http2;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">679</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">listen [::]:8444 ssl http2;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">680</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">server_name </span><span style="--0:#E1E4E8;--1:#24292E">$substore_domain</span><span style="--0:#9ECBFF;--1:#032F62">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">681</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">682</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">ssl_certificate /home/$(</span><span style="--0:#B392F0;--1:#6F42C1">id</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-un</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#E1E4E8;--1:#24292E">$userid</span><span style="--0:#9ECBFF;--1:#032F62">)/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.cer;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">683</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">ssl_certificate_key /home/$(</span><span style="--0:#B392F0;--1:#6F42C1">id</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-un</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#E1E4E8;--1:#24292E">$userid</span><span style="--0:#9ECBFF;--1:#032F62">)/</span><span style="--0:#E1E4E8;--1:#24292E">$domain</span><span style="--0:#9ECBFF;--1:#032F62">.key;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">684</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">685</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">location / {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">686</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy_pass http://127.0.0.1:3001;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">687</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy_set_header Host </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">host;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">688</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy_set_header X-Real-IP </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">remote_addr;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">689</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">        </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy_set_header X-Forwarded-For </span><span style="--0:#79B8FF;--1:#005CC5">\$</span><span style="--0:#9ECBFF;--1:#032F62">proxy_add_x_forwarded_for;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">690</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">691</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">692</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">693</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">694</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 移除默认配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">695</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">rm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-f</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/sites-enabled/default</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">696</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">697</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 测试配置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">698</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"测试Nginx配置..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">699</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">700</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">701</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 重启Nginx</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">702</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_info</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"重启Nginx..."</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">703</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">restart</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">704</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">705</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">log_success</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Nginx分流配置完成"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">706</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">707</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">708</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">709</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#                 主逻辑                     #</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">710</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">##############################################</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">711</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">712</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">main</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">713</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#79B8FF;--1:#005CC5">$#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-eq</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]] </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> [[ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"--help"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">show_help</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">714</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">715</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> cmd</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$1</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">716</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">shift</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">717</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">718</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">[[ </span><span style="--0:#F97583;--1:#BF3441">-n</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">COMMAND_MAP</span><span style="--0:#9ECBFF;--1:#032F62">[</span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">]}"</span><span style="--0:#E1E4E8;--1:#24292E"> ]] </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">panic</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"未知命令: </span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">719</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">720</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 同样地，这里也要避免直接 IFS="::" 分割</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">721</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 先用 '|' 替换 "::" ，再做一次分割即可</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">722</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> info</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">COMMAND_MAP</span><span style="--0:#9ECBFF;--1:#032F62">[</span><span style="--0:#E1E4E8;--1:#24292E">$cmd</span><span style="--0:#9ECBFF;--1:#032F62">]}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">723</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">info</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"${</span><span style="--0:#E1E4E8;--1:#24292E">info</span><span style="--0:#F97583;--1:#BF3441">//::/</span><span style="--0:#9ECBFF;--1:#032F62">|}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">724</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">725</div></div><div class="code"><span class="indent">  </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> desc handler options_str</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">726</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">IFS</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"|"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">desc</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">handler</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">options_str</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;&#x3C;</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$info</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">727</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">728</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># 调用对应的处理函数</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">729</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">  </span></span><span style="--0:#E1E4E8;--1:#24292E">$handler </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$@</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">730</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">731</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">732</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$EUID</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-ne</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> ]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">733</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">log_warning</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请使用 root 用户运行此脚本"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>&#x26;2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">734</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">735</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">736</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">737</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">main</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#79B8FF;--1:#005CC5">$@</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#!/usr/bin/env bash#==================================================================# ██╗  ██╗   ██╗███╗   ██╗██████╗ ██████╗  █████╗# ██║  ╚██╗ ██╔╝████╗  ██║██╔══██╗██╔══██╗██╔══██╗# ██║   ╚████╔╝ ██╔██╗ ██║██║  ██║██████╔╝███████║# ██║    ╚██╔╝  ██║╚██╗██║██║  ██║██╔══██╗██╔══██║# ███████╗██║   ██║ ╚████║██████╔╝██║  ██║██║  ██║# ╚══════╝╚═╝   ╚═╝  ╚═══╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝#==================================================================## 文件名称: build-all.sh# 文件描述: VPS 搭建脚本，包含域名申请，3XUI面板搭建、Sub-Store服务安装、#        Hysteria2 安装、Nginx分流配置。需 root 用户运行。#       运行前请自定义修改117-131的端口号。## 作者: Lyndra <lyndra.hyst@gmail.com># 版本: 1.0.0# 创建日期: 2025-04-25# 最后修改: 2025-05-29## 使用许可: GPLv2 or other licenses# Copyright (c) 2025 Lyndra##==================================================================set -eo pipefail# 颜色配置RED=&#x27;\033[0;31m&#x27;GREEN=&#x27;\033[0;32m&#x27;YELLOW=&#x27;\033[1;33m&#x27;BLUE=&#x27;\033[0;34m&#x27;NC=&#x27;\033[0m&#x27;# 命令配置，格式为：[命令名]=&#x22;描述::处理函数::选项声明1::选项声明2::...&#x22;declare -A COMMAND_MAP=(  [&#x22;setup&#x22;]=&#x22;基础环境设置::handle_setup::-u,--user:指定新建用户名（必须）::-p,--pass:指定新建用户密码（必须）::-s,--ssh-port:指定SSH端口（默认：22222）&#x22;  [&#x22;cert&#x22;]=&#x22;证书管理::handle_cert::-d,--domain:指定主域名（必须，建议优先使用二级域名，可免费开启cloudflare代理保护，三级域名不可免费使用）::-e,--email:指定邮箱（必须）::-t,--token:指定Cloudflare API Token（必须）::-z,--zone-id:指定Cloudflare Zone ID（必须）::-a,--account-id:指定Cloudflare Account ID（必须）&#x22;  [&#x22;hysteria&#x22;]=&#x22;Hysteria2服务::handle_hysteria::-d,--domain:指定域名（必须，确定证书路径）::-p,--port:指定端口（默认：8443）::-u,--user:指定用户名（必须）::-w,--pass:指定密码（必须）&#x22;  [&#x22;xui&#x22;]=&#x22;X-UI面板::handle_xui&#x22;  [&#x22;substore&#x22;]=&#x22;Sub-Store服务::handle_substore::-a,--api-key:指定API密钥（必须）&#x22;  [&#x22;nginx&#x22;]=&#x22;Nginx分流配置::handle_nginx::-d,--domain:指定域名（必须，确定证书路径）::-x,--xui-domain:指定X-UI域名（必须）::-s,--substore-domain:指定Sub-Store域名（必须）::-p,--port-xui:指定xui访问端口（必须）&#x22;)# 错误处理函数panic() {  echo -e &#x22;${RED}[错误]${NC} $1&#x22; >&#x26;2  exit 1}# 日志输出函数log_info() {  echo -e &#x22;${GREEN}[信息]${NC} $1&#x22; >&#x26;2}log_warning() {  echo -e &#x22;${YELLOW}[警告]${NC} $1&#x22; >&#x26;2}log_success() {  echo -e &#x22;${GREEN}[成功]${NC} $1&#x22; >&#x26;2}log_debug() {  echo -e &#x22;${BLUE}[调试]${NC} $1&#x22; >&#x26;2}###############################################          通用的帮助信息生成函数            ###############################################show_command_help() {  local cmd=&#x22;$1&#x22;  local info=&#x22;${COMMAND_MAP[$cmd]}&#x22;  # 1) 把所有 &#x22;::&#x22; 替换成一个不会在脚本中出现的分隔符，比如 &#x27;|&#x27;  info=&#x22;${info//::/|}&#x22;  # 2) 这时才能安全地用 IFS=&#x27;|&#x27; 来做分割  local desc handler options_str  IFS=&#x22;|&#x22; read -r desc handler options_str <<<&#x22;$info&#x22;  echo -e &#x22;${YELLOW}命令: ${GREEN}$cmd${NC}&#x22;  echo -e &#x22;${YELLOW}描述: ${NC}$desc&#x22;  echo -e &#x22;${YELLOW}选项:${NC}&#x22;  # 3) 选项声明里可能有多段「::」分隔，继续替换并拆分  options_str=&#x22;${options_str//::/|}&#x22;  IFS=&#x22;|&#x22; read -ra opt_lines <<<&#x22;$options_str&#x22;  for opt_line in &#x22;${opt_lines[@]}&#x22;; do    [[ -z &#x22;$opt_line&#x22; ]] &#x26;&#x26; continue    # opt_line 类似 &#x22;-p,--package:指定包名（必须）&#x22;    # 用 &#x22;:&#x22; 分割出（短+长选项）和描述    IFS=&#x22;:&#x22; read -r flags desc <<<&#x22;$opt_line&#x22;    printf &#x22;  ${GREEN}%-20s${NC} %s\n&#x22; &#x22;$flags&#x22; &#x22;$desc&#x22;  done}# 主帮助信息show_help() {  echo -e &#x22;${YELLOW}使用方法:${NC}&#x22;  echo &#x22;  $0 [命令] [选项]&#x22;  echo  echo -e &#x22;${YELLOW}可用命令:${NC}&#x22;  for cmd in &#x22;${!COMMAND_MAP[@]}&#x22;; do    local desc=${COMMAND_MAP[$cmd]%%::*}    printf &#x22;  ${GREEN}%-15s${NC} %s\n&#x22; &#x22;$cmd&#x22; &#x22;$desc&#x22;  done  echo -e &#x22;\n使用 ${YELLOW}$0 命令 --help${NC} 查看具体命令帮助&#x22;}###############################################               命令处理函数                 ################################################ ==========================================# 配置信息开始，请根据实际情况修改# ==========================================# 新建用户的组id和用户id，默认 1001groupid=1001userid=1001# ssh 登陆端口配置，请确保该端口未被占用port_ssh=22222# Hysteria 主端口配置port_hysteria=8443# Hysteria 跳跃端口配置port_hysteria_jump_1=50220port_hysteria_jump_1_end=50959port_hysteria_jump_2=60133port_hysteria_jump_2_end=60968# ==========================================# 配置信息结束# ==========================================# 基础环境设置handle_setup() {  local username=&#x22;&#x22;  local password=&#x22;&#x22;  while [[ $# -gt 0 ]]; do    case $1 in    -u | --user)      username=&#x22;$2&#x22;      shift 2      ;;    -p | --pass)      password=&#x22;$2&#x22;      shift 2      ;;    -s | --ssh-port)      port_ssh=&#x22;$2&#x22;      shift 2      ;;    -h | --help)      show_command_help &#x22;setup&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  [[ -z &#x22;$username&#x22; ]] &#x26;&#x26; panic &#x22;必须指定用户名&#x22;  [[ -z &#x22;$password&#x22; ]] &#x26;&#x26; panic &#x22;必须指定密码&#x22;  log_info &#x22;开始设置基础环境...&#x22;  # 安装常用软件  log_info &#x22;安装常用软件...&#x22;  apt update &#x26;&#x26; apt upgrade -y&#x26;&#x26; apt-get install -y curl vim ufw sudo  # 创建非root用户  log_info &#x22;创建非root用户: $username&#x22;  getent group ${groupid} || groupadd -g ${groupid} vps  getent passwd &#x22;$username&#x22; || useradd -ms /bin/bash -u ${userid} -g ${groupid} -G sudo &#x22;$username&#x22;  echo &#x22;$username:$password&#x22; | chpasswd  echo &#x22;$username ALL=(ALL) NOPASSWD:ALL&#x22; >> /etc/sudoers  log_info &#x22;非root用户创建完成，请在新终端中使用 $username 用户登录，确认是否生效，生效请输入 y/Y，否则请重新运行脚本&#x22;  read -p &#x22;请输入y确认：&#x22; confirm  if [ &#x22;$confirm&#x22; != &#x22;y&#x22; ] &#x26;&#x26; [ &#x22;$confirm&#x22; != &#x22;Y&#x22; ]; then    panic &#x22;非root用户创建完成未生效，请检测系统环境，重新运行脚本&#x22;  fi  # SSH安全加固  log_info &#x22;配置SSH安全设置...&#x22;  # 检查 SSH 端口是否已经修改  if grep -q &#x22;^Port $port_ssh&#x22; /etc/ssh/sshd_config; then    log_info &#x22;SSH 端口已设置为 $port_ssh，跳过修改&#x22;  else    sed -i &#x22;s/#Port 22/Port $port_ssh/&#x22; /etc/ssh/sshd_config    sed -i &#x22;s/^Port 22/Port $port_ssh/&#x22; /etc/ssh/sshd_config    log_info &#x22;SSH 端口已修改为 $port_ssh&#x22;  fi  # 检查 root 登录是否已经禁用  if grep -q &#x22;^PermitRootLogin no&#x22; /etc/ssh/sshd_config; then    log_info &#x22;Root 登录已禁用，跳过修改&#x22;  else    sed -i &#x22;s/#PermitRootLogin yes/PermitRootLogin no/&#x22; /etc/ssh/sshd_config    sed -i &#x22;s/^PermitRootLogin yes/PermitRootLogin no/&#x22; /etc/ssh/sshd_config    log_info &#x22;Root 登录已禁用&#x22;  fi  ufw allow &#x22;$port_ssh&#x22;  ufw deny 22  systemctl restart ssh  log_info &#x22;SSH安全设置完成，请在新终端中使用新端口 ssh -p ${port_ssh} ${username}@ip，确认是否生效，生效请输入 y/Y，否则请重新运行脚本&#x22;  read -p &#x22;请输入y确认：&#x22; confirm  if [ &#x22;$confirm&#x22; != &#x22;y&#x22; ] &#x26;&#x26; [ &#x22;$confirm&#x22; != &#x22;Y&#x22; ]; then    panic &#x22;SSH安全设置未生效，请检测系统环境，重新运行脚本&#x22;  fi  # 防火墙设置  log_info &#x22;配置防火墙...&#x22;  ufw allow 80  ufw allow 443  ufw --force enable  log_success &#x22;基础环境设置完成&#x22;}# 证书管理# 证书管理 - 改进版本handle_cert() {  local email=&#x22;&#x22;  local cf_token=&#x22;&#x22;  local cf_zone_id=&#x22;&#x22;  local cf_account_id=&#x22;&#x22;  local domain=&#x22;&#x22;  local key_type=&#x22;ec-256&#x22;  # 新增：默认使用 EC-256  while [[ $# -gt 0 ]]; do    case $1 in    -d | --domain)      domain=&#x22;$2&#x22;      shift 2      ;;    -e | --email)      email=&#x22;$2&#x22;      shift 2      ;;    -t | --token)      cf_token=&#x22;$2&#x22;      shift 2      ;;    -z | --zone-id)      cf_zone_id=&#x22;$2&#x22;      shift 2      ;;    -a | --account-id)      cf_account_id=&#x22;$2&#x22;      shift 2      ;;    -k | --key-type)      key_type=&#x22;$2&#x22;      shift 2      ;;    -h | --help)      show_command_help &#x22;cert&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  [[ -z &#x22;$domain&#x22; ]] &#x26;&#x26; panic &#x22;必须指定主域名&#x22;  [[ -z &#x22;$email&#x22; ]] &#x26;&#x26; panic &#x22;必须指定邮箱&#x22;  [[ -z &#x22;$cf_token&#x22; ]] &#x26;&#x26; panic &#x22;必须指定Cloudflare API Token&#x22;  [[ -z &#x22;$cf_zone_id&#x22; ]] &#x26;&#x26; panic &#x22;必须指定Cloudflare Zone ID&#x22;  [[ -z &#x22;$cf_account_id&#x22; ]] &#x26;&#x26; panic &#x22;必须指定Cloudflare Account ID&#x22;  # 验证密钥类型  case &#x22;$key_type&#x22; in    &#x22;ec-256&#x22;|&#x22;ec-384&#x22;|&#x22;2048&#x22;|&#x22;3072&#x22;|&#x22;4096&#x22;)      ;;    *)      panic &#x22;不支持的密钥类型: $key_type，支持: ec-256, ec-384, 2048, 3072, 4096&#x22;      ;;  esac  log_info &#x22;开始申请TLS证书（密钥类型: $key_type）...&#x22;  # 安装acme.sh  log_info &#x22;安装acme.sh...&#x22;  curl https://get.acme.sh | sh -s email=&#x22;$email&#x22;  apt install socat -y  ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt  source ~/.bashrc  ~/.acme.sh/acme.sh --upgrade --auto-upgrade  # 设置环境变量  export CF_Token=&#x22;$cf_token&#x22;  export CF_Zone_ID=&#x22;$cf_zone_id&#x22;  export CF_Account_ID=&#x22;$cf_account_id&#x22;  # 申请证书  local username=$(id -un 1001)  log_info &#x22;申请证书: $domain（密钥类型: $key_type）&#x22;  # 检查证书是否已经存在且有效  if [[ -f &#x22;/home/$username/$domain.cer&#x22; ]] &#x26;&#x26; [[ -f &#x22;/home/$username/$domain.key&#x22; ]]; then    if openssl x509 -in &#x22;/home/$username/$domain.cer&#x22; -noout -checkend 2592000 > /dev/null 2>&#x26;1; then      log_info &#x22;证书已存在且有效期超过30天，跳过申请&#x22;      log_success &#x22;证书检查完成&#x22;      return 0    else      log_warning &#x22;证书已存在但即将过期或无效，重新申请&#x22;    fi  fi  # 构建 acme.sh 命令  local acme_cmd=&#x22;~/.acme.sh/acme.sh --issue --dns dns_cf -d \&#x22;$domain\&#x22; -d \&#x22;*.$domain\&#x22;&#x22;  # 添加密钥长度参数  acme_cmd=&#x22;$acme_cmd --keylength $key_type&#x22;  # 添加输出文件参数  acme_cmd=&#x22;$acme_cmd --key-file /home/$username/$domain.key&#x22;  acme_cmd=&#x22;$acme_cmd --fullchain-file /home/$username/$domain.cer&#x22;  acme_cmd=&#x22;$acme_cmd --reloadcmd &#x27;bash -c \&#x22;nginx -s reload &#x26;&#x26; x-ui restart\&#x22;&#x27;&#x22;  # 执行命令  eval $acme_cmd || log_warning &#x22;证书申请结果请检查，目前没有安装 nginx，会导致reload失败，但不代表证书申请失败&#x22;  # 修改权限  log_info &#x22;修改证书权限...&#x22;  chmod 644 &#x22;/home/$username/$domain.key&#x22;  chmod 644 &#x22;/home/$username/$domain.cer&#x22;  # 将证书重命名拷贝，并确保路径正确，主要用于xui设置路径  mkdir -p &#x22;/root/cert/$domain&#x22;  cp &#x22;/home/$username/$domain.cer&#x22; &#x22;/root/cert/$domain/fullchain.pem&#x22;  cp &#x22;/home/$username/$domain.key&#x22; &#x22;/root/cert/$domain/privkey.pem&#x22;  # 验证证书  log_info &#x22;验证证书...&#x22;  if openssl x509 -in &#x22;/home/$username/$domain.cer&#x22; -noout -text > /dev/null 2>&#x26;1; then    log_info &#x22;证书文件有效&#x22;    # 显示证书信息    log_info &#x22;证书有效期：&#x22;    openssl x509 -in &#x22;/home/$username/$domain.cer&#x22; -noout -dates    log_info &#x22;证书包含的域名：&#x22;    openssl x509 -in &#x22;/home/$username/$domain.cer&#x22; -noout -text | grep -A1 &#x22;Subject Alternative Name&#x22; || echo &#x22;  $domain, *.$domain&#x22;  else    log_warning &#x22;证书文件可能有问题，请检查&#x22;  fi  log_success &#x22;证书申请完成&#x22;}# Hysteria2服务# 逐步在Qos,建议搭建realityhandle_hysteria() {  local username=&#x22;&#x22;  local password=&#x22;&#x22;  local domain=&#x22;&#x22;  while [[ $# -gt 0 ]]; do    case $1 in    -d | --domain)      domain=&#x22;$2&#x22;      shift 2      ;;    -p | --port)      port_hysteria=&#x22;$2&#x22;      shift 2      ;;    -u | --user)      username=&#x22;$2&#x22;      shift 2      ;;    -w | --pass)      password=&#x22;$2&#x22;      shift 2      ;;    -h | --help)      show_command_help &#x22;hysteria&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  [[ -z &#x22;$domain&#x22; ]] &#x26;&#x26; panic &#x22;必须指定主域名&#x22;  [[ -z &#x22;$username&#x22; ]] &#x26;&#x26; panic &#x22;必须指定用户名&#x22;  [[ -z &#x22;$password&#x22; ]] &#x26;&#x26; panic &#x22;必须指定密码&#x22;  log_info &#x22;开始安装Hysteria2服务...&#x22;  # 安装Hysteria2  log_info &#x22;安装Hysteria2...&#x22;  bash <(curl -fsSL https://get.hy2.sh/)  # 配置Hysteria2  log_info &#x22;配置Hysteria2...&#x22;  cat > /etc/hysteria/config.yaml << EOFlisten: :$port_hysteriatls:  cert: /home/$(id -un $userid)/$domain.cer  key: /home/$(id -un $userid)/$domain.keyauth:  type: userpass  userpass:    $username: $passwordmasquerade:  type: proxy  proxy:    url: https://bing.com    rewriteHost: true  listenHTTP: :80  listenHTTPS: :$port_hysteriabandwidth:  up: 20 mbps  down: 50 mbpsEOF  # 配置端口跳跃  log_info &#x22;配置端口跳跃...&#x22;  ufw allow $port_hysteria_jump_1:$port_hysteria_jump_1_end/udp  ufw allow $port_hysteria_jump_2:$port_hysteria_jump_2_end/udp  iptables -t nat -A PREROUTING -i eth0 -p udp --dport $port_hysteria_jump_1:$port_hysteria_jump_1_end -j REDIRECT --to-ports &#x22;$port_hysteria&#x22;  iptables -t nat -A PREROUTING -i eth0 -p udp --dport $port_hysteria_jump_2:$port_hysteria_jump_2_end -j REDIRECT --to-ports &#x22;$port_hysteria&#x22;  ip6tables -t nat -A PREROUTING -i eth0 -p udp --dport $port_hysteria_jump_1:$port_hysteria_jump_1_end -j REDIRECT --to-ports &#x22;$port_hysteria&#x22;  ip6tables -t nat -A PREROUTING -i eth0 -p udp --dport $port_hysteria_jump_2:$port_hysteria_jump_2_end -j REDIRECT --to-ports &#x22;$port_hysteria&#x22;  ufw allow $port_hysteria  log_info &#x22;启动Hysteria2服务...&#x22;  systemctl enable hysteria-server.service --now  log_success &#x22;Hysteria2服务安装完成&#x22;}# 3X-UI面板handle_xui() {  while [[ $# -gt 0 ]]; do    case $1 in    -h | --help)      show_command_help &#x22;xui&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  log_info &#x22;开始安装3X-UI面板...&#x22;  # 安装X-UI  log_info &#x22;安装3X-UI...&#x22;  bash <(curl -Ls https://raw.githubusercontent.com/MHSanaei/3x-ui/refs/tags/v2.6.0/install.sh)  # 配置X-UI  log_info &#x22;请手动配置3X-UI，或者使用3X-UI备份恢复&#x22;  sleep 2  x-ui  log_success &#x22;3X-UI面板安装完成，请在 ngninx 反代后，手动完成 ssl 证书路径配置&#x22;}# Sub-Store服务handle_substore() {  local api_key=&#x22;&#x22;  while [[ $# -gt 0 ]]; do    case $1 in    -a | --api-key)      api_key=&#x22;$2&#x22;      shift 2      ;;    -h | --help)      show_command_help &#x22;substore&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  [[ -z &#x22;$api_key&#x22; ]] &#x26;&#x26; panic &#x22;必须指定API密钥&#x22;  log_info &#x22;开始安装Sub-Store服务...&#x22;  # 安装依赖  log_info &#x22;安装依赖...&#x22;  apt update -y &#x26;&#x26; apt install unzip curl wget git -y  # 安装FNM  log_info &#x22;安装FNM...&#x22;  curl -fsSL https://fnm.vercel.app/install | bash  source ~/.bashrc  # 安装Node  log_info &#x22;安装Node...&#x22;  fnm install v20.18.0  # 安装PNPM  log_info &#x22;安装PNPM...&#x22;  curl -fsSL https://get.pnpm.io/install.sh | sh -  source ~/.bashrc  # 创建目录  log_info &#x22;创建目录...&#x22;  mkdir -p /root/sub-store  cd /root/sub-store  # 下载Sub-Store  log_info &#x22;下载Sub-Store...&#x22;  curl -fsSL https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js -o sub-store.bundle.js  curl -fsSL https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip -o dist.zip  unzip -o dist.zip &#x26;&#x26; mv dist frontend &#x26;&#x26; rm dist.zip  # 创建服务  log_info &#x22;创建服务...&#x22;  cat > /etc/systemd/system/sub-store.service << EOF[Unit]Description=Sub-StoreAfter=network-online.targetWants=network-online.target systemd-networkd-wait-online.service[Service]LimitNOFILE=32767Type=simpleEnvironment=&#x22;SUB_STORE_FRONTEND_BACKEND_PATH=/$api_key&#x22;Environment=&#x22;SUB_STORE_BACKEND_CRON=0 0 * * *&#x22;Environment=&#x22;SUB_STORE_FRONTEND_PATH=/root/sub-store/frontend&#x22;Environment=&#x22;SUB_STORE_FRONTEND_HOST=0.0.0.0&#x22;Environment=&#x22;SUB_STORE_FRONTEND_PORT=3001&#x22;Environment=&#x22;SUB_STORE_DATA_BASE_PATH=/root/sub-store&#x22;Environment=&#x22;SUB_STORE_BACKEND_API_HOST=127.0.0.1&#x22;Environment=&#x22;SUB_STORE_BACKEND_API_PORT=3000&#x22;ExecStart=/root/.local/share/fnm/fnm exec --using v20.18.0 node /root/sub-store/sub-store.bundle.jsUser=rootGroup=rootRestart=on-failureRestartSec=5sExecStartPre=/bin/sh -c ulimit -n 51200StandardOutput=journalStandardError=journal[Install]WantedBy=multi-user.targetEOF  # 启动服务  log_info &#x22;启动服务...&#x22;  systemctl enable sub-store.service --now  source /root/.bashrc  log_success &#x22;Sub-Store服务安装完成&#x22;}# Nginx分流配置handle_nginx() {  local xui_domain=&#x22;&#x22;  local substore_domain=&#x22;&#x22;  local domain=&#x22;&#x22;  local port_xui=&#x22;&#x22;  while [[ $# -gt 0 ]]; do    case $1 in    -d | --domain)      domain=&#x22;$2&#x22;      shift 2      ;;    -x | --xui-domain)      xui_domain=&#x22;$2&#x22;      shift 2      ;;    -s | --substore-domain)      substore_domain=&#x22;$2&#x22;      shift 2      ;;    -p | --port-xui)      port_xui=&#x22;$2&#x22;      shift 2      ;;    -h | --help)      show_command_help &#x22;nginx&#x22;      exit 0      ;;    *)      panic &#x22;未知选项: $1&#x22;      ;;    esac  done  [[ -z &#x22;$domain&#x22; ]] &#x26;&#x26; panic &#x22;必须指定主域名&#x22;  [[ -z &#x22;$xui_domain&#x22; ]] &#x26;&#x26; panic &#x22;必须指定X-UI域名&#x22;  [[ -z &#x22;$substore_domain&#x22; ]] &#x26;&#x26; panic &#x22;必须指定Sub-Store域名&#x22;  [[ -z &#x22;$port_xui&#x22; ]] &#x26;&#x26; panic &#x22;必须指定X-UI访问端口&#x22;  log_info &#x22;开始配置Nginx分流...&#x22;  # 安装Nginx  log_info &#x22;安装Nginx...&#x22;  apt install libnginx-mod-stream nginx -y  # 配置Nginx  log_info &#x22;配置Nginx...&#x22;  # 修改主配置文件 - 检查是否已经存在 include 语句  if ! grep -q &#x22;include /etc/nginx/vps.conf;&#x22; /etc/nginx/nginx.conf; then    log_info &#x22;添加 vps.conf 包含语句到 nginx.conf&#x22;    sudo sed -i &#x27;$a\    include /etc/nginx/vps.conf;&#x27; /etc/nginx/nginx.conf  else    log_info &#x22;vps.conf 包含语句已存在，跳过添加&#x22;  fi  # 创建分流配置  cat > /etc/nginx/vps.conf << EOF# /etc/nginx/vps.confstream {    # 定义一个映射，将 SNI 中的服务器名映射到后端标识符    map \$ssl_preread_server_name \$backend {        hostnames;        $substore_domain sub;        $xui_domain xui;        default hysteria;  # 默认后端    }    # 定义各个后端的上游服务器    upstream sub {        server 127.0.0.1:8444;  # $substore_domain 对应的后端，对接的是 nginx server    }    upstream xui {        server 127.0.0.1:$port_xui;  # $xui_domain 对应的后端    }    upstream hysteria {        server 127.0.0.1:$port_hysteria;  # 默认后端    }    # 定义一个服务器块，监听指定端口并根据 SNI 分发流量    server {        listen 443;        listen [::]:443;        proxy_pass \${backend};        ssl_preread on;    }}EOF  # 创建Sub-Store服务器配置  cat > /etc/nginx/sites-enabled/vps.conf << EOFserver {    listen 8444 ssl http2;    listen [::]:8444 ssl http2;    server_name $substore_domain;    ssl_certificate /home/$(id -un $userid)/$domain.cer;    ssl_certificate_key /home/$(id -un $userid)/$domain.key;    location / {        proxy_pass http://127.0.0.1:3001;        proxy_set_header Host \$host;        proxy_set_header X-Real-IP \$remote_addr;        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;    }}EOF  # 移除默认配置  rm -f /etc/nginx/sites-enabled/default  # 测试配置  log_info &#x22;测试Nginx配置...&#x22;  nginx -t  # 重启Nginx  log_info &#x22;重启Nginx...&#x22;  systemctl restart nginx  log_success &#x22;Nginx分流配置完成&#x22;}###############################################                 主逻辑                     ###############################################main() {  [[ $# -eq 0 ]] || [[ &#x22;$1&#x22; == &#x22;--help&#x22; ]] &#x26;&#x26; show_help &#x26;&#x26; exit 0  local cmd=&#x22;$1&#x22;  shift  [[ -n &#x22;${COMMAND_MAP[$cmd]}&#x22; ]] || panic &#x22;未知命令: $cmd&#x22;  # 同样地，这里也要避免直接 IFS=&#x22;::&#x22; 分割  # 先用 &#x27;|&#x27; 替换 &#x22;::&#x22; ，再做一次分割即可  local info=&#x22;${COMMAND_MAP[$cmd]}&#x22;  info=&#x22;${info//::/|}&#x22;  local desc handler options_str  IFS=&#x22;|&#x22; read -r desc handler options_str <<<&#x22;$info&#x22;  # 调用对应的处理函数  $handler &#x22;$@&#x22;}if [ &#x22;$EUID&#x22; -ne 0 ]; then    log_warning &#x22;请使用 root 用户运行此脚本&#x22; >&#x26;2    exit 1fimain &#x22;$@&#x22;"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">run.sh 壳脚本</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#!/bin/bash</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██╗  ██╗   ██╗███╗   ██╗██████╗ ██████╗  █████╗</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║  ╚██╗ ██╔╝████╗  ██║██╔══██╗██╔══██╗██╔══██╗</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║   ╚████╔╝ ██╔██╗ ██║██║  ██║██████╔╝███████║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ██║    ╚██╔╝  ██║╚██╗██║██║  ██║██╔══██╗██╔══██║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ███████╗██║   ██║ ╚████║██████╔╝██║  ██║██║  ██║</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># ╚══════╝╚═╝   ╚═╝  ╚═══╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 文件名称: run.sh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 文件描述: VPS构建脚本</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 运行环境：Debian 系 Linux 系统，Root 用户运行。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 注意事项：</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>44 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   1. 运行前，请运行 build-all.sh --help 查看脚本中的命令含义，以及每个指令的参数含义。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   2. 尽可能的先修改 build-all.sh 中的配置端口，保证安全（119-141行）。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   3. 通过Cloudflare申请DNS时，需要确认Cloudflare的api令牌，是否允许了新 vps 的ipv4和ipv6地址。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   4. 尽可能的使用二级域名，CF的代理功能中，二级域名边缘证书是免费的，但三级域名需要开会员才能用。三级域名签发证书，同时使用代理功能，会导致SSL握手失败。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   5. XUI提供备份和恢复功能，但是需要注意其SSL证书路径也会被备份，如果新旧机器的证书不一致，将导致无法网页访问，此时需要命令行修改XUI的SSL证书路径。本脚本会自动复制证书到xui的证书路径。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   6. 对于 xui 上启用的各种协议所需要的端口请手动放行防火墙。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#   7. sub-store 建议开启github的glist备份，网上有很多教程，很简单。新机器可以直接完美同步。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 作者: Lyndra &#x3C;lyndra.hyst@gmail.com></span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 版本: 1.0.0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 创建日期: 2025-05-29</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 最后修改: 2025-05-29</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 使用许可: GPLv2 or other licenses</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># Copyright (c) 2025 Lyndra</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#==================================================================</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">31</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">32</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"运行前请先修改 *build-all.sh* 和 *本脚本* 中的配置信息，确保配置信息正确。"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">33</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">34</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"输入 y/Y 确认上述操作已完成，输入 n/N 退出"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">35</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请输入: "</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">confirm</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">36</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">37</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"y"</span><span style="--0:#E1E4E8;--1:#24292E"> ] &#x26;&#x26; [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$confirm</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"Y"</span><span style="--0:#E1E4E8;--1:#24292E"> ]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">38</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"退出脚本"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">39</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">exit</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">40</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">41</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">42</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 创建新用户，请根据实际情况修改用户名和密码</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">43</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 密码需要足够复杂，否则创建用户时会失败。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">44</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">setup</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">username</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">password</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">45</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">46</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 申请证书，请根据实际情况修改域名、邮箱、cloudflare的api令牌、cloudflare zone id、cloudflare account id。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">47</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 请确认cloudflare的api令牌，是否允许了新 vps 的ipv4和ipv6地址。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">48</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cert</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">二级域名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">邮箱</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">api_token</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-z</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">zone_id</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-a</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">account_id</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">49</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">50</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 安装 hysteria2，请根据实际情况修改域名、用户名、密码。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">51</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">二级域名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">用户名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-w</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">密码</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">52</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">53</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 安装 xui，安装过程中请自行配置xui，并记录xui的访问端口</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">54</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">55</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">56</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 安装 sub-store，请修改token，否则可能会被盗取后端信息。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">57</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">substore</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-a</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">custom_token</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">58</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">59</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./build-all.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">二级域名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-x</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xui-域名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub-store-域名</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui-访问端口</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#!/bin/bash#==================================================================# ██╗  ██╗   ██╗███╗   ██╗██████╗ ██████╗  █████╗# ██║  ╚██╗ ██╔╝████╗  ██║██╔══██╗██╔══██╗██╔══██╗# ██║   ╚████╔╝ ██╔██╗ ██║██║  ██║██████╔╝███████║# ██║    ╚██╔╝  ██║╚██╗██║██║  ██║██╔══██╗██╔══██║# ███████╗██║   ██║ ╚████║██████╔╝██║  ██║██║  ██║# ╚══════╝╚═╝   ╚═╝  ╚═══╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝#==================================================================## 文件名称: run.sh# 文件描述: VPS构建脚本# 运行环境：Debian 系 Linux 系统，Root 用户运行。# 注意事项：#   1. 运行前，请运行 build-all.sh --help 查看脚本中的命令含义，以及每个指令的参数含义。#   2. 尽可能的先修改 build-all.sh 中的配置端口，保证安全（119-141行）。#   3. 通过Cloudflare申请DNS时，需要确认Cloudflare的api令牌，是否允许了新 vps 的ipv4和ipv6地址。#   4. 尽可能的使用二级域名，CF的代理功能中，二级域名边缘证书是免费的，但三级域名需要开会员才能用。三级域名签发证书，同时使用代理功能，会导致SSL握手失败。#   5. XUI提供备份和恢复功能，但是需要注意其SSL证书路径也会被备份，如果新旧机器的证书不一致，将导致无法网页访问，此时需要命令行修改XUI的SSL证书路径。本脚本会自动复制证书到xui的证书路径。#   6. 对于 xui 上启用的各种协议所需要的端口请手动放行防火墙。#   7. sub-store 建议开启github的glist备份，网上有很多教程，很简单。新机器可以直接完美同步。# 作者: Lyndra <lyndra.hyst@gmail.com># 版本: 1.0.0# 创建日期: 2025-05-29# 最后修改: 2025-05-29# 使用许可: GPLv2 or other licenses# Copyright (c) 2025 Lyndra##==================================================================echo &#x22;运行前请先修改 *build-all.sh* 和 *本脚本* 中的配置信息，确保配置信息正确。&#x22;echo &#x22;输入 y/Y 确认上述操作已完成，输入 n/N 退出&#x22;read -p &#x22;请输入: &#x22; confirmif [ &#x22;$confirm&#x22; != &#x22;y&#x22; ] &#x26;&#x26; [ &#x22;$confirm&#x22; != &#x22;Y&#x22; ]; then    echo &#x22;退出脚本&#x22;    exit 0fi# 创建新用户，请根据实际情况修改用户名和密码# 密码需要足够复杂，否则创建用户时会失败。./build-all.sh setup -u username -p password# 申请证书，请根据实际情况修改域名、邮箱、cloudflare的api令牌、cloudflare zone id、cloudflare account id。# 请确认cloudflare的api令牌，是否允许了新 vps 的ipv4和ipv6地址。./build-all.sh cert -d 二级域名 -e 邮箱 -t api_token -z zone_id -a account_id# 安装 hysteria2，请根据实际情况修改域名、用户名、密码。./build-all.sh hysteria -d 二级域名 -u 用户名 -w 密码# 安装 xui，安装过程中请自行配置xui，并记录xui的访问端口./build-all.sh xui# 安装 sub-store，请修改token，否则可能会被盗取后端信息。./build-all.sh substore -a custom_token./build-all.sh nginx -d 二级域名 -x xui-域名 -s sub-store-域名 -p x-ui-访问端口"><div></div></button></div></figure></div> </article> <div class="divider-horizontal"></div> <div class="h-8 text-skin-base"> <div></div> <div class="flex item-center float-right w-auto max-w-[40%] text-right"> <a class="truncate " href="/blog/manjaro-x11-双显示屏" title="Manjaro外接显示器KDE Plasma桌面卡住解决方案"> Manjaro外接显示器KDE Plasma桌面卡住解决方案 </a> <i class="ri-arrow-right-s-fill float-right"></i> </div> </div> <div class="border-l-4 my-4 p-4 border-l-skin-base bg-skin-card break-all"> <div>本文标题：VPS 搭建脚本</div> <div>文章作者：Lyndra</div> <div>发布时间：2025-06-03</div> <div> 原始链接：<a href="https://www.hysling.top/blog/proxy/vps-搭建脚本" class="hover:text-skin-active">https://www.hysling.top/blog/proxy/vps-搭建脚本</a> </div> </div>  </div>  <div class="giscus"></div> <script src="https://giscus.app/client.js" data-repo="LLyndra/Lyndra-Blog" data-repo-id="R_kgDOO0ngsw" data-category="Announcements" data-category-id="DIC_kwDOO0ngs84Cq7zX" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous"></script> </div> <div class="hidden xl:block col-span-1 relative"> <div class="shadow-lg rounded-lg h-64 w-auto flex flex-col items-center justify-center bg-skin-card p-2"> <img class="avatar mb-4" src="/avatar.svg" alt="avatar"> <div class="mb-2 text-center">本来无一物，何处惹尘埃</div> <div class="flex items-center justify-center flex-wrap"> <a title="github" href="https://github.com/LLyndra" target="_blank"> <i class="ri-github-fill text-2xl mr-2 cursor-pointer"></i> </a><a title="rss" href target="_blank"> <i class="ri-rss-fill text-2xl mr-2 cursor-pointer"></i> </a> </div> </div> <div id="toc" class="shadow-lg rounded-lg my-4 py-2 px-2 bg-skin-card sticky top-20" data-astro-cid-6t6zfk7k> <div class="aside-widget" data-astro-cid-6t6zfk7k> <i class="ri-list-check menu-icon" data-astro-cid-6t6zfk7k></i> 文章目录 </div> <div class="overflow-auto" data-astro-cid-6t6zfk7k> <div class="toc-container" data-astro-cid-6t6zfk7k></div> </div> </div>  <script type="module" src="/_astro/Toc.astro_astro_type_script_index_0_lang.R6DO86cs.js"></script> </div> <button type="button" id="scrollToTopBtn" class="header-btn fixed bottom-4 right-2 hidden" title="scroll to top"> <i class="ri-arrow-up-line"></i> </button> <script type="module">let o=document.getElementById("scrollToTopBtn");window.addEventListener("scroll",function(){window.scrollY>200?o.style.display="block":o.style.display="none"});o.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})});</script> </div> <div class="h-16 container p-1 absolute left-0 bottom-0"> <div class="flex items-center justify-center text-skin-base"> <span id="busuanzi_container_site_pv"> 总访问量<span id="busuanzi_value_site_pv"></span>次 </span> <div class="divider-vertical"></div> <span id="busuanzi_container_site_uv"> 总访客数<span id="busuanzi_value_site_uv"></span>人次 </span> </div> <div class="flex items-center flex-col flex-wrap justify-center mb-4 text-skin-base first:mb-0 sm:flex-row"> <div> <span class="cursor-default">Copyright</span> <i class="ri-copyright-line align-middle"></i> <span class="align-middle">2025</span> </div>  <div class="divider-vertical"></div> <a href="/sitemap-0.xml">站点地图</a> </div> </div> </main> <script type="module" src="/_astro/BlogPost.astro_astro_type_script_index_0_lang.C_bBgou1.js"></script></body></html>